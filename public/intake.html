<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>한남주택관리 입주자카드</title>
    
    <!-- Tailwind & Fonts (디자인 전용 추가) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #1a1a1a;
            color: #f0f0f0;
        }
        .form-container {
            background-color: #2c2c2c;
            border: 1px solid #444;
        }
        .progress-bar-fill {
            transition: width 0.5s ease-in-out;
        }
        .btn-primary {
            background: linear-gradient(145deg, #d4af37, #b08f2d);
            color: #1a1a1a;
            font-weight: 700;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.2);
            transition: all 0.3s ease;
        }
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(212, 175, 55, 0.3);
        }
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: translateY(0);
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.2);
        }
        .btn-secondary {
            background-color: #4a4a4a;
            color: #f0f0f0;
            border: 1px solid #666;
            transition: background-color 0.3s ease;
            border-radius: 8px; /* 통일성을 위해 추가 */
            font-weight: 700; /* 통일성을 위해 추가 */
            padding: 0.5rem 1.5rem; /* 통일성을 위해 추가 */
        }
        .btn-secondary:hover {
            background-color: #5a5a5a;
        }
        .form-input, .form-textarea, .custom-date-input {
            background-color: #3a3a3a;
            border: 1px solid #555;
            color: #f0f0f0;
            border-radius: 8px;
        }
        .form-input:focus, .form-textarea:focus, .custom-date-input:focus {
            outline: none;
            border-color: #d4af37;
            box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.5);
        }
        .form-label {
            color: #ccc;
        }
        /* Custom scrollbar */
        .policy-text::-webkit-scrollbar { width: 8px; }
        .policy-text::-webkit-scrollbar-track { background: #3a3a3a; border-radius: 10px; }
        .policy-text::-webkit-scrollbar-thumb { background: #d4af37; border-radius: 10px; }
        .policy-text::-webkit-scrollbar-thumb:hover { background: #b08f2d; }
        
        .page { display: none; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Custom Date Input Style */
        .custom-date-input {
            position: relative;
            cursor: pointer;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"><path fill="%23d4af37" d="M20 3h-1V1h-2v2H7V1H5v2H4c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 18H4V10h16v11zM4 8V5h16v3H4z"/></svg>');
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1.25rem;
        }
        
        input[type="date"]::-webkit-calendar-picker-indicator {
            opacity: 0;
            position: absolute;
            left: 0; top: 0;
            width: 100%; height: 100%;
            cursor: pointer;
        }

        input[type="date"] {
            color-scheme: dark; 
        }

        /* Image Preview Style */
        .image-preview-item {
            position: relative;
            padding-top: 100%; /* 1:1 Aspect Ratio */
            border-radius: 8px;
            overflow: hidden;
            background-color: #3a3a3a;
        }
        .image-preview-item img {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            object-fit: cover;
            cursor: pointer;
        }
        .image-delete-btn {
            position: absolute; top: 4px; right: 4px;
            width: 24px; height: 24px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white; border: none; border-radius: 50%;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 14px; font-weight: bold; line-height: 1;
            transition: background-color 0.2s;
            z-index: 10;
        }
        .image-delete-btn:hover {
            background-color: rgba(239, 68, 68, 0.9);
        }

        /* Image Modal Styles */
        .image-modal {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex; align-items: center; justify-content: center;
            z-index: 1000;
            animation: fadeInModal 0.3s;
        }
        .image-modal-content {
            max-width: 90%; max-height: 90%;
            object-fit: contain;
        }
        .image-modal-close {
            position: absolute; top: 20px; right: 20px;
            color: white; font-size: 40px; cursor: pointer;
            z-index: 1001;
        }
        @keyframes fadeInModal {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>

<body class="min-h-screen flex items-center justify-center p-4">
    <div id="app-container" class="w-full max-w-md mx-auto">

        <!-- 진행바/제목/페이지 (디자인 적용) -->
        <div id="form-wizard" class="form-container rounded-2xl p-6 md:p-8 shadow-2xl space-y-6 hidden">
            <div id="progress-container" class="w-full bg-gray-600 rounded-full h-2.5">
                <div id="progress-bar" class="bg-gradient-to-r from-yellow-500 to-amber-400 h-2.5 rounded-full progress-bar-fill" style="width: 0%"></div>
            </div>
            
            <h2 id="page-title" class="text-2xl font-bold text-center text-gray-100"></h2>

            <!-- 동적 콘텐츠 -->
            <div id="page-content" class="min-h-[400px] flex flex-col justify-between"></div>

            <!-- 네비게이션 (디자인 적용) -->
            <div id="navigation-buttons" class="flex justify-between items-center pt-4">
                <button id="prev-btn" class="btn-secondary py-2 px-6 rounded-lg font-semibold">이전</button>
                <span id="step-counter" class="text-sm text-gray-400"></span>
                <button id="next-btn" class="btn-primary py-2 px-6 rounded-lg font-bold">다음 →</button>
                <button id="submit-btn" class="btn-primary py-2 px-6 rounded-lg font-bold hidden">제출하기</button>
            </div>
        </div>

        <!-- 이미 제출/만료 (디자인 적용) -->
        <div id="already-submitted" class="form-container rounded-2xl p-8 shadow-2xl text-center space-y-4 hidden">
             <svg class="mx-auto h-16 w-16 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <h2 class="text-2xl font-bold text-gray-100">제출 완료</h2>
            <p class="text-gray-300">입주자카드 작성을 이미 완료하셨습니다. <br> 추가 문의는 관리사무소로 연락주시기 바랍니다.</p>
            <div class="mt-6 border-t border-gray-700 pt-6 space-y-3">
                <p class="font-semibold text-lg">한남주택관리 042-489-8555</p>
                <a href="http://pf.kakao.com/_ggrxaK/chat" target="_blank" rel="noopener noreferrer" class="inline-flex items-center justify-center gap-2 mt-3 bg-[#FEE500] text-black px-5 py-2.5 rounded-lg font-bold hover:opacity-90 transition-opacity">
                    <svg viewBox="0 0 32 32" class="w-6 h-6"><path fill="currentColor" d="M16 4.64c-6.96 0-12.64 4.48-12.64 10.08 0 3.52 2.24 6.624 5.76 8.48l-1.92 7.04 7.52-3.84c.448.064.896.064 1.344.064 6.96 0 12.64-4.48 12.64-10.08S22.96 4.64 16 4.64z"></path></svg>
                    카카오톡 채널 추가
                </a>
            </div>
             <!-- view-data-btn 제거됨 (Firebase 로직에는 없음) -->
        </div>

        <!-- 동의 모달 (디자인 적용) -->
        <div id="consent-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden">
            <div class="bg-gray-800 rounded-2xl p-8 max-w-sm w-full text-center shadow-2xl border border-yellow-500/30">
                <h3 class="text-xl font-bold text-yellow-400 mb-4">안내</h3>
                <p class="text-gray-300 mb-6">개인정보 수집 및 이용에 동의하지 않으실 경우, 입주자카드 작성을 진행할 수 없습니다.</p>
                <button id="close-modal-btn" class="btn-primary w-full py-2.5 rounded-lg">확인</button>
            </div>
        </div>

        <!-- 사진 모달 (디자인 적용) -->
        <div id="image-fullscreen-modal" class="image-modal hidden">
            <span id="image-modal-close-btn" class="image-modal-close">&times;</span>
            <img id="image-modal-content" class="image-modal-content" src="" alt="Full size image">
        </div>
    </div>

    <!-- ===== 스크립트 (로직은 원본 유지 + UI 로직/디자인 적용) ===== -->
    <script type="module">
        /* ===== Firebase SDK (CDN) ===== */
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-functions.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCPQqCufM8BHclkqy26vHsPuVyvcjuVHs0",
            authDomain: "hannam-move-calculate.firebaseapp.com",
            projectId: "hannam-move-calculate",
            appId: "1:578721983901:web:84c3ff829069cb5ecf1374",
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const functions = getFunctions(app, "asia-northeast3");

        // ===== 상태/DOM (디자인 적용) =====
        let currentStep = 1;
        const totalSteps = 7;
        let formData = { photo_files: [], checklist: {} };
        let signaturePad, ctx;
        let isDrawing = false;
        let uploadedFiles = [];
        
        const logoBase64 = "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/4gHYSUNDX1BST0ZJTEUAAQEAAAHIAAAAAAQwAABtbnRyUkdCIFhZWiAAAAAAAAAAAAAAAABhY3NwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAA9tYAAQAAAADTLQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAApkZXNjAAAA/AAAAHxjcHJ0AAABcAAAACh3dHB0AAABoAAAAAxyVFJDAAABvAAAAA5nVFJDAAABvAAAAA5iVFJDAAABvAAAAA5kZXNjAAAAAAAAAANjMgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB0ZXh0AAAAAElYAABDb3B5cmlnaHQgKEMpIDIwMjIgR2vZ2xlIExMQwAAAA5zZjA2AAAAAAEAACovAAAFoAAAACg/AAARiQAAHdQABVguAAEBdAAB/9sAQwADAgIDAgIDAwMDBAMDBAUIBQUEBAUKBwcGCAwKDAwLCgsLDQ4SEA0OEQ4LCxAWEBETFBUVFQwPFxgWFBgSFBUU/9sAQwEDBAQFBAUJBQUJFA0LDRQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQU/8AAEQgBiAGIAwEiAAIRAQADAQD/xAAfAAAEFAQEBAQEBAAAAAAAAAAABAgMEBQYHCAkKC//EALUQAAIBAwMCBAMFBQQEAAABfQECAwAEEQUSITFBBhNRYQcicRQygZGhCCNCscEVUtHwJDNicoIJChYXGBkaJSYnKCkqNDU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6g4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2drh4uPk5ebn6Onq8fLz9PX29/j5+v/EAB8BAAMBAQEBAQEBAQEAAAAAAAABAgMEBQYHCAkKC//EALURAAIBAgQEAwQHBQQEAAECdwABAgMRBAUhMQYSQVEHYXETIjKBCBRCkaGxwQkjM1LwFWJy0QoWJDThJfEXGBkaJicoKSo2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6g4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TVWdTW1tfY2drh4uPk5ebn6Onq8fLz9PX29/j5+v/aAAwDAQACEQMRAD8A/vrorzLwH8WdL+AGteI9I0bTvFC3nhPVzoWsvqfhrVNItoL4RRTtHbS31tAlzGYpowZYS8YJK7tytt+m6ACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAPgj9nH/ka/aJ/wCyyaj/AOm3S6+/a+BP2cf+Rr/aJ/7LJqP/AKbdLr77oAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAPgj9nH/ka/aJ/wCyyaj/AOm3S6+/a+BP2cf+Rr/aJ/7LJqP/AKbdLr77oAKKKKACiiigAooooAKKKK";

        const formWizard = document.getElementById('form-wizard');
        const progressBar = document.getElementById('progress-bar');
        const pageTitleEl = document.getElementById('page-title');
        const pageContentEl = document.getElementById('page-content');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const submitBtn = document.getElementById('submit-btn');
        const stepCounter = document.getElementById('step-counter');
        const consentModal = document.getElementById('consent-modal');
        const closeModalBtn = document.getElementById('close-modal-btn'); // (디자인 적용)
        const alreadySubmittedEl = document.getElementById('already-submitted');
        const imageModal = document.getElementById('image-fullscreen-modal');
        const imageModalContent = document.getElementById('image-modal-content');
        const imageModalCloseBtn = document.getElementById('image-modal-close-btn');

        const token = new URLSearchParams(location.search).get("t");
        async function ensureAuth() { if (!auth.currentUser) await signInAnonymously(auth); }
        async function verifyToken() {
            const verify = httpsCallable(functions, "verifyIntakeToken");
            const res = await verify({ token });
            return res.data;
        }

        // ===== 페이지 콘텐츠 (디자인/문구 적용) =====
        
        function generateChecklistSection(title, items) {
            const checklistItems = items.map(item => `<label class="flex items-center space-x-3 p-2 rounded-md hover:bg-gray-700/50 cursor-pointer"><div class="relative flex items-center justify-center w-5 h-5"><input type="checkbox" name="${title}_${item}" class="absolute opacity-0 w-full h-full cursor-pointer peer"><div class="w-5 h-5 border-2 border-gray-500 rounded-md bg-gray-600 peer-checked:bg-amber-400 peer-checked:border-amber-400 transition-all duration-200 flex-shrink-0"></div><svg class="absolute w-4 h-4 text-gray-900 hidden peer-checked:block" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg></div><span>${item}</span></label>`).join('');
            return `<fieldset class="border border-gray-600 p-4 rounded-lg"><legend class="px-2 text-lg font-semibold text-amber-400">${title}</legend><div class="grid grid-cols-2 gap-x-4 gap-y-2">${checklistItems}</div></fieldset>`;
        }
        
        const pages = {
            1: {
                title: '환영합니다',
                content: `
                    <div class="text-center flex-grow flex flex-col justify-center items-center p-4">
                        <h3 class="text-3xl font-bold text-gray-100 mb-4">환영합니다</h3>
                        <img src="${logoBase64}" alt="한남주택관리 로고" class="mb-4 w-32 h-32 object-contain">
                        <p class="text-xl font-semibold text-amber-400 mb-6">입주자카드 작성</p>
                        <div class="text-gray-300 text-left space-y-2 bg-gray-700/30 p-4 rounded-lg">
                             <p>새로운 보금자리에 입주하신 것을 진심으로<br>환영합니다.</p>
                             <p>본 카드는 입주 시점의 상태를 정확히 기록하여,<br>거주하시는 동안 그리고 퇴실 시 발생할 수 있는<br>분쟁을 예방하기 위한 중요한 자료입니다.</p>
                             <p>우측 하단의 <span class="font-bold text-amber-400">[다음 →]</span> 버튼을 눌러 각 항목을<br>꼼꼼히 확인하고 작성해 주시기 바랍니다.</p>
                        </div>
                    </div>
                `
            },
            2: {
                title: '개인정보 수집 및 이용 동의',
                content: `
                    <div class="h-full flex flex-col p-1">
                        <div class="policy-text overflow-y-auto pr-2 flex-grow bg-gray-800/50 p-4 rounded-lg text-sm text-gray-300 space-y-4">
                            <p class="font-semibold text-gray-100">본 체크리스트는 입주민의 편의를 위한 상태 기록용 문서로, 작성된 내용은 해당 거주지의 상태 확인 및 관리 목적으로만 사용됩니다.</p>
                            <div><h4 class="font-bold text-amber-400 mb-1">✔ 수집 항목</h4><p>- 이름, 연락처, 주소, 체크리스트 응답 내용, 서명</p></div>
                            <div><h4 class="font-bold text-amber-400 mb-1">✔ 수집 목적</h4><p>- 퇴실 시 상태 비교, 하자 발생 시 증빙자료 확보, 관리대장 작성</p></div>
                            <div><h4 class="font-bold text-amber-400 mb-1">✔ 보관 기간</h4><p>- 퇴실일로부터 최대 1년 (또는 관리 목적 달성 시까지)</p></div>
                            <div><h4 class="font-bold text-amber-400 mb-1">✔ 제3자 제공</h4><p>- 없음</p></div>
                            <div><h4 class="font-bold text-amber-400 mb-1">✔ 보관 주체</h4><p>- 해당 건물 관리사무소 또는 위탁 관리업체</p></div>
                            <p class="font-semibold text-gray-100 pt-2">※ 위 목적 외 사용되거나 외부에 제공되지 않으며, 동의하지 않으실 경우 체크리스트 제출이 제한될 수 있습니다.</p>
                        </div>
                    </div>
                `
            },
            3: {
                title: '개인정보 동의 확인',
                content: `
                    <div class="flex-grow flex flex-col justify-center items-center p-4">
                        <p class="text-lg font-semibold text-center mb-4 text-gray-100">개인정보 수집 및 이용에 동의하십니까?</p>
                        <p class="text-sm text-center mb-8 text-gray-400">※ 해당 체크리스트는 개인정보 수집 및 이용 동의가 필요합니다. 동의하지 않으실 경우 제출이 제한되거나, 체크리스트 확인이 어려울 수 있습니다.</p>
                        <div class="space-y-4 w-full max-w-xs">
                            <label class="flex items-center p-4 bg-gray-700/50 rounded-lg cursor-pointer hover:bg-gray-700/80"><input type="radio" name="consent" value="agree" class="hidden peer"><div class="w-6 h-6 border-2 border-gray-400 rounded-full mr-4 peer-checked:border-amber-400 peer-checked:bg-amber-400 relative"></div><span class="text-gray-100">동의합니다</span></label>
                            <label class="flex items-center p-4 bg-gray-700/50 rounded-lg cursor-pointer hover:bg-gray-700/80"><input type="radio" name="consent" value="disagree" class="hidden peer"><div class="w-6 h-6 border-2 border-gray-400 rounded-full mr-4 peer-checked:border-red-500 peer-checked:bg-red-500 relative"></div><span class="text-gray-100">동의하지 않습니다</span></label>
                        </div>
                    </div>
                `
            },
            4: {
                title: '입주자 정보',
                content: `
                     <div class="space-y-5 py-4">
                        <div><label for="name" class="form-label block mb-1.5 text-sm font-medium">성함</label><input type="text" id="name" name="name" class="form-input w-full p-3" placeholder="홍길동"></div>
                        <div><label for="phone" class="form-label block mb-1.5 text-sm font-medium">전화번호</label><input type="tel" id="phone" name="phone" class="form-input w-full p-3" placeholder="010-1234-5678"></div>
                        <div><label for="address" class="form-label block mb-1.5 text-sm font-medium">주소</label><input type="text" id="address" name="address" class="form-input w-full p-3" placeholder="상세 주소를 입력해주세요"></div>
                        <div><label for="villa_name" class="form-label block mb-1.5 text-sm font-medium">빌라명</label><input type="text" id="villa_name" name="villa_name" class="form-input w-full p-3" placeholder="예) 한남빌라 101호"></div>
                        <div><label for="move_in_date" class="form-label block mb-1.5 text-sm font-medium">입주날짜</label><input type="date" id="move_in_date" name="move_in_date" class="custom-date-input w-full p-3"></div>
                    </div>
                `
            },
            5: {
                title: '체크리스트 (1/2)',
                content: `
                    <div class="space-y-4"><div class="bg-gray-800/50 p-3 rounded-lg text-center text-sm text-gray-300"><p class="font-semibold text-gray-100">각 공간의 시설물 상태를 확인해주세요.</p><p>하자가 있는 항목에 체크해주시고, 목록에 없는 내용은 마지막 페이지의 '기타 하자내용'에 상세히 기재해주시면 됩니다.</p></div><div class="space-y-6 overflow-y-auto pr-2 h-[320px] policy-text">${generateChecklistSection('방', ['도배', '장판', '몰딩', '문짝', '조명', '창문', '방충망'])}${generateChecklistSection('주방', ['도배', '장판', '씽크대', '인덕션(가스레인지, 쿡탑)', '후드', '조명', '수전(수도꼭지)'])}${generateChecklistSection('욕실', ['타일', '조명', '문짝', '세면대', '변기', '거울', '수전(수도꼭지)', '수건장', '악세사리세트', '환풍기', '배수', '창문', '방충망'])}</div></div>`
            },
            6: {
                title: '체크리스트 (2/2)',
                content: `<div class="space-y-6 overflow-y-auto pr-2 h-[400px] policy-text">${generateChecklistSection('베란다(테라스)', ['타일', '조명', '창문', '방충망', '누수(물 새는 곳)'])}${generateChecklistSection('옵션', ['TV', '냉장고', '세탁기', '건조기', '스타일러', '전자레인지', '에어컨', '침대', '보일러', '쇼파', '붙박이장', '블라인드'])}</div>`
            },
            7: {
                title: '기타 및 서명',
                content: `
                    <div class="space-y-6 h-full flex flex-col">
                        <div><label for="notes" class="form-label block mb-1.5 text-sm font-medium">기타 하자내용</label><textarea id="notes" name="notes" rows="3" class="form-textarea w-full p-3" placeholder="특이사항이나 사진으로 담기 힘든 내용을 기재해주세요."></textarea></div>
                        <div>
                            <label for="photos" class="form-label block mb-1.5 text-sm font-medium">사진 업로드</label>
                            <input type="file" id="photos" name="photos" multiple accept="image/*" class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-amber-100 file:text-amber-700 hover:file:bg-amber-200 cursor-pointer">
                            <p id="photo-upload-desc" class="text-xs text-gray-400 mt-2 transition-colors">하자 부위 사진을 최대 5장까지 첨부할 수 있습니다.</p>
                            <div id="image-preview-container" class="mt-4 grid grid-cols-3 sm:grid-cols-4 gap-4"></div>
                        </div>
                        <div class="flex-grow flex flex-col"><label class="form-label block mb-1.5 text-sm font-medium">서명</label><div class="relative w-full h-32"><canvas id="signature-pad" class="bg-gray-700 rounded-lg w-full h-full"></canvas><button id="clear-signature" type="button" class="absolute top-2 right-2 text-xs bg-gray-800 text-white px-2 py-1 rounded">지우기</button></div></div>
                    </div>`
            }
        };

        // ===== UI/UX Helper Functions (디자인 적용) =====
        function renderImagePreviews() {
            const previewContainer = document.getElementById('image-preview-container');
            if (!previewContainer) return;
            previewContainer.innerHTML = '';
            uploadedFiles.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const item = document.createElement('div');
                    item.className = 'image-preview-item';
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.alt = `Preview ${index + 1}`;
                    img.addEventListener('click', () => showImageModal(e.target.result));

                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'image-delete-btn';
                    deleteBtn.innerHTML = '&times;';
                    deleteBtn.dataset.index = index;
                    deleteBtn.addEventListener('click', (event) => {
                        event.stopPropagation();
                        const idxToRemove = parseInt(event.target.dataset.index);
                        uploadedFiles.splice(idxToRemove, 1);
                        renderImagePreviews();
                        updatePhotoUploadDesc();
                    });
                    
                    item.appendChild(img);
                    item.appendChild(deleteBtn);
                    previewContainer.appendChild(item);
                };
                reader.readAsDataURL(file);
            });
        }

        function updatePhotoUploadDesc() {
            const photoDesc = document.getElementById('photo-upload-desc');
             if (uploadedFiles.length > 0) {
                photoDesc.textContent = `현재 ${uploadedFiles.length}개 첨부됨 (최대 5개)`;
            } else {
                photoDesc.textContent = '하자 부위 사진을 최대 5장까지 첨부할 수 있습니다.';
            }
            photoDesc.classList.remove('text-red-500');
            photoDesc.classList.add('text-gray-400');
        }
        
        function addPhotoUploadListener() {
            const photosInput = document.getElementById('photos'); // ID 'photos'로 변경
            const photoDesc = document.getElementById('photo-upload-desc');
            if (photosInput) {
                photosInput.addEventListener('change', (e) => {
                    const newFiles = Array.from(e.target.files);
                    const totalFiles = uploadedFiles.length + newFiles.length;
                    
                    if (totalFiles > 5) {
                        photoDesc.textContent = '사진은 최대 5장까지 업로드할 수 있습니다.';
                        photoDesc.classList.add('text-red-500');
                        photoDesc.classList.remove('text-gray-400');
                    } else {
                        uploadedFiles.push(...newFiles);
                        updatePhotoUploadDesc();
                        renderImagePreviews();
                    }
                    e.target.value = ''; // Reset input
                });
            }
        }

        function showImageModal(src) {
            imageModalContent.src = src;
            imageModal.classList.remove('hidden');
        }

        function hideImageModal() {
            imageModal.classList.add('hidden');
            imageModalContent.src = '';
        }

        function initSignaturePad() {
            signaturePad = document.getElementById('signature-pad');
            ctx = signaturePad.getContext('2d');
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            signaturePad.width = signaturePad.offsetWidth * ratio;
            signaturePad.height = signaturePad.offsetHeight * ratio;
            signaturePad.getContext('2d').scale(ratio, ratio);
            ctx.strokeStyle = '#FFFFFF'; ctx.lineWidth = 2;
            ['mousedown', 'touchstart'].forEach(evt => signaturePad.addEventListener(evt, startDrawing, { passive: false }));
            ['mouseup', 'touchend'].forEach(evt => signaturePad.addEventListener(evt, stopDrawing, { passive: false }));
            ['mousemove', 'touchmove'].forEach(evt => signaturePad.addEventListener(evt, draw, { passive: false }));
            document.getElementById('clear-signature').addEventListener('click', () => ctx.clearRect(0, 0, signaturePad.width, signaturePad.height));
        }

        function getEventPos(e) {
            const rect = signaturePad.getBoundingClientRect();
            const touch = e.touches ? e.touches[0] : null;
            return { x: (touch || e).clientX - rect.left, y: (touch || e).clientY - rect.top };
        }

        function startDrawing(e) { e.preventDefault(); isDrawing = true; const pos = getEventPos(e); ctx.beginPath(); ctx.moveTo(pos.x, pos.y); }
        function stopDrawing(e) { e.preventDefault(); isDrawing = false; ctx.beginPath(); }
        function draw(e) { if (!isDrawing) return; e.preventDefault(); const pos = getEventPos(e); ctx.lineTo(pos.x, pos.y); ctx.stroke(); ctx.beginPath(); ctx.moveTo(pos.x, pos.y); }


        // ===== Core Logic Functions (디자인 적용 및 연결) =====
        
        function saveData() {
            const inputs = pageContentEl.querySelectorAll('input, textarea');
            inputs.forEach(input => {
                if (input.type === 'checkbox') {
                    if (!formData.checklist) formData.checklist = {};
                    formData.checklist[input.name] = input.checked;
                } else if (input.type === 'radio') {
                    if (input.checked) formData[input.name] = input.value;
                } else if (input.type !== 'file') {
                    formData[input.id || input.name] = input.value;
                }
            });
            localStorage.setItem('residentCardDraft', JSON.stringify(formData));
        }

        function loadData() {
            // (초기화 로직에서 formData를 미리 채우므로, 여기서는 DOM에 바인딩)
            const inputs = pageContentEl.querySelectorAll('input, textarea');
            inputs.forEach(input => {
                if (input.type === 'checkbox') {
                    const v = formData.checklist?.[input.name];
                    if (typeof v !== 'undefined') input.checked = v;
                } else if (input.type === 'radio') {
                    if (formData[input.name] === input.value) input.checked = true;
                } else if (input.type !== 'file') {
                    const key = input.id || input.name;
                    if (formData[key]) input.value = formData[key];
                }
            });
            if (currentStep === 7) renderImagePreviews(); // (디자인 적용)
        }

        function updateUI() {
            const page = pages[currentStep];
            if (!page) return;
            pageTitleEl.textContent = page.title;
            pageContentEl.innerHTML = page.content;
            pageContentEl.scrollTop = 0; // (디자인 적용)
            progressBar.style.width = `${((currentStep - 1) / (totalSteps - 1)) * 100}%`;
            stepCounter.textContent = `${currentStep} / ${totalSteps}`;
            prevBtn.style.display = currentStep > 1 ? 'block' : 'none'; // (디자인 적용)
            nextBtn.style.display = currentStep < totalSteps ? 'block' : 'none'; // (디자인 적용)
            submitBtn.style.display = currentStep === totalSteps ? 'block' : 'none'; // (디자인 적용)

            // (디자인 적용 - UI 로직)
            if (currentStep === 3) addConsentListeners();
            if (currentStep === 7) {
                initSignaturePad();
                addPhotoUploadListener();
            }

            loadData();
            validateStep();
        }
        
        // (디자인 적용 - UI 로직)
        function addConsentListeners() {
            document.querySelectorAll('input[name="consent"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    if (e.target.value === 'disagree') consentModal.classList.remove('hidden');
                    validateStep();
                });
            });
        }

        // (디자인 적용 - 유효성 검사)
        function validateStep() {
            let isValid = false;
            if (currentStep === 3) {
                const consent = document.querySelector('input[name="consent"]:checked');
                isValid = consent && consent.value === 'agree';
            } else if (currentStep === 4) {
                isValid = ['name', 'phone', 'address', 'villa_name', 'move_in_date'].every(id => document.getElementById(id)?.value.trim());
            } else {
                isValid = true;
            }
            nextBtn.disabled = !isValid;
            submitBtn.disabled = false; // 제출 버튼은 마지막 단계에서 항상 활성화 (로직은 handleSubmit에서 처리)
        }

        function nextStep(){ if (currentStep < totalSteps){ saveData(); currentStep++; updateUI(); } }
        function prevStep(){ if (currentStep > 1){ saveData(); currentStep--; updateUI(); } }

        async function handleSubmit() {
            saveData();

            // (디자인 적용 - 서명 및 사진 데이터 수집)
            const signatureData = signaturePad.toDataURL();
            const blankCanvas = document.createElement('canvas');
            blankCanvas.width = signaturePad.width; blankCanvas.height = signaturePad.height;
            if (signatureData !== blankCanvas.toDataURL()) formData.signature = signatureData;
            
            const filePromises = uploadedFiles.map(file => new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = e => reject(e);
                reader.readAsDataURL(file);
            }));
            formData.photo_files = await Promise.all(filePromises);


            // (원본 Firebase 로직)
            const payload = {
                move_in_date: formData["move_in_date"] || "",
                villa_name:   formData["villa_name"]   || "",
                address:      formData["address"]      || "",
                name:         formData["name"]         || "",
                phone:        formData["phone"]        || "",
                checklist:    formData.checklist    || {},
                notes:        formData["notes"]        || "",
                photos:       formData.photo_files || [], // (데이터 연결)
                signature:    formData.signature || ""  // (데이터 연결)
            };

            // (디자인 적용 - 제출 버튼 비활성화)
            submitBtn.disabled = true;
            submitBtn.textContent = "제출 중...";

            const submit = httpsCallable(functions, "submitResidentCard");
            try {
                 await submit({ token, payload });

                localStorage.removeItem('residentCardDraft');
                formWizard.classList.add('hidden');
                alreadySubmittedEl.classList.remove('hidden');
                // (성공 문구는 already-submitted HTML에 이미 포함됨)
            } catch (e) {
                console.error("Submit failed:", e);
                alert("제출 중 오류가 발생했습니다. 다시 시도해주세요.");
                // (디자인 적용 - 버튼 활성화)
                submitBtn.disabled = false;
                submitBtn.textContent = "제출하기";
            }
        }

        // 바인딩 (디자인 적용)
        prevBtn?.addEventListener('click', prevStep);
        nextBtn?.addEventListener('click', nextStep);
        submitBtn?.addEventListener('click', handleSubmit);
        closeModalBtn?.addEventListener('click', () => consentModal.classList.add('hidden'));
        imageModalCloseBtn?.addEventListener('click', hideImageModal);
        imageModal.addEventListener('click', (e) => {
            if (e.target === imageModal) hideImageModal();
        });
        pageContentEl?.addEventListener('input', validateStep);


        // 초기화 (로직 수정)
        (async () => {
            // *** FIX: Bypassing token check for preview/testing ***
            // In a real environment, the token check is necessary.
            /*
            if (!token) {
                alreadySubmittedEl.classList.remove('hidden');
                alreadySubmittedEl.querySelector('h2').textContent = "오류";
                alreadySubmittedEl.querySelector('p').innerHTML = "유효하지 않은 접근입니다. <br> 관리자에게 문의하세요.";
                alreadySubmittedEl.querySelector('svg').style.display = 'none'; // Hide success checkmark
                alreadySubmittedEl.querySelector('.mt-6.border-t').style.display = 'none'; // Hide contact info
                console.error("Token is missing from URL.");
                return; // Stop execution
            }
            */

            await ensureAuth();
            
            // We will assume the token is "active" for this preview.
            try {
                // const v = await verifyToken(); // Bypassed for preview
                // if (v?.status === "active") { // Assuming active
                    const pre = {}; // Bypassed: v.prefill || {};
                    const draft = JSON.parse(localStorage.getItem('residentCardDraft') || "{}");
                    
                    // (로직 수정: prefill과 draft를 글로벌 formData에 병합)
                    formData = { 
                        ...formData, // 기본값 (photo_files: [], checklist: {})
                        ...pre,      // Firebase prefill
                        ...draft,    // LocalStorage draft
                        checklist: { ...pre.checklist, ...draft.checklist } // 체크리스트는 깊은 병합
                    };
                    // 병합된 데이터로 draft 갱신
                    localStorage.setItem('residentCardDraft', JSON.stringify(formData));
                    
                    formWizard.classList.remove('hidden');
                    updateUI(); // updateUI는 이제 글로벌 formData를 읽어옴
                // } else {
                //     alreadySubmittedEl.classList.remove('hidden');
                // }
            } catch (e) {
                // This catch block is now mainly for localStorage or other unexpected errors
                alreadySubmittedEl.classList.remove('hidden');
                alreadySubmittedEl.querySelector('h2').textContent = "오류";
                alreadySubmittedEl.querySelector('p').innerHTML = "초기화 중 오류가 발생했습니다. <br> 관리자에게 문의하세요.";
                alreadySubmittedEl.querySelector('svg').style.display = 'none'; // Hide success checkmark
                console.error("Initialization failed:", e);
            }
        })();
    </script>
  </body>
</html>

